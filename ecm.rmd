---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: myparametrs.tex
fontsize: 12pt
fig_caption: true
title: "Влияние полной и частичной легализации марихуаны на смертность от передозировок опиоидами"
subtitle: "анализ данных"
author:
- name: "Валера"
geometry: margin=1in
abstract:
toc:  true
# spacing: double
bibliography: lib.bib


---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)

```
```{r global_options, include = FALSE}
knitr::opts_chunk$set(message=FALSE, 
tidy.opts=list(width.cutoff=40), echo = FALSE, dev = 'cairo_pdf') 

```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2) 
library(dplyr) 
library(reshape2) 
library(stats) 
library(lmtest) 
library(car) 
library(ggcorrplot)
library(stargazer)
library(estimatr)
library(lmtest)
library(readxl)
library(tidyr)
library(ggpubr)
library(extrafont)
```

```{r include=FALSE}
# it's a kind of magic, skip it
`%--%` <- function(x, y) {
  do.call(sprintf, c(list(x), y))
}

theme_set(theme_bw() + theme(text=element_text(family="serif", size=40)))
# source: https://www.kff.org/other/state-indicator/opioid-overdose-death-rates
# read 20 csv files for overdoses and create panel data from them
naming <- "overdose_rate/overdose_%s.csv" %--% list(1999:2018)
overdose <- data.frame()
for (i in c(1:length(naming))) {
  a <- read.csv(naming[i], skip = 2, header = TRUE, nrows = 52, na.strings = c("NR", "NSD"))
  a$year <- 1998 + i
  overdose <- rbind(overdose, a)
}
# change order of columns and redact their names
overdose <- overdose[c(1,4,2,3)]
names(overdose) <- c("state", "year", "opioid_death_rate", "alldrugs_death_rate")


# read excel file with information about legalization years by state (hand-made)
leg <- read_xlsx("legalization.xlsx", col_names = TRUE, na = c("NA"))
# and create panel data from this table
legal <- data.frame()
for (i in 1:nrow(leg)) {
  data <- data.frame(state=leg[i,1], year=c(1990:2019))
  data$med <- c(ifelse(data$year <= c(leg[i,2]), 0, 1))
  data$full <- c(ifelse(data$year <= c(leg[i,4]), 0, 1))
  legal <- rbind(legal, data)
}


# processing file for unemployment, GDP per capita (real), personal income per capita

# source: https://www.icip.iastate.edu/tables/employment/unemployment-states
# read the file, make long format, delete the first column;
unemployment <- read_xls("unemployment.xls", sheet = "States", skip = 5, col_names = TRUE, n_max = 52) %>%
                gather(year, unemployment, "1980":"2018") %>% select(-1)
# edit col name of state and change year format to numeric
names(unemployment)[1] <- "state"
unemployment$year <- as.numeric(unemployment$year)

# source: https://apps.bea.gov/iTable/iTable.cfm?acrdn=2&isuri=1&reqid=70&step=1#acrdn=2&isuri=1&reqid=70&step=1
# read the file, make long format, delete the first column; edit col name of state and change year format
gdp_per_cap_real <- read_xls("gdp_per_cap_real.xls", skip = 5, col_names = TRUE, n_max = 60) %>% 
                    gather(year, gdp_per_cap, "1997":"2018") %>% select(-1)
names(gdp_per_cap_real)[1] <- "state"
gdp_per_cap_real$year <- as.numeric(gdp_per_cap_real$year)

# source: https://apps.bea.gov/iTable/iTable.cfm?acrdn=2&isuri=1&reqid=70&step=1#acrdn=2&isuri=1&reqid=70&step=1
# read the file, make long format, delete the first column; edit col name of state; edit col name of state and change year format
personal_income_per_cap <- read_xls("personal_income_per_cap.xls", skip = 5, col_names = TRUE, n_max = 60) %>%
                           gather(year, personal_income_per_cap, "1999":"2018") %>% select(-1)
names(personal_income_per_cap)[1] <- "state"
personal_income_per_cap$year <- as.numeric(personal_income_per_cap$year)


# source: https://www.openicpsr.org/openicpsr/project/105583/version/V3/view;jsessionid=5A68D3A66B257C49163707BF7B76B1EE
# mini processing of alcohol consumption data
alco_consumption <- read.csv("alco_consumption.csv") %>% select(state=state, year=year, 
                                                                alco_consumption=ethanol_all_drinks_gallons_per_capita)


# source: https://ucr.fbi.gov/crime-in-the-u.s
# read excel for year 2004 (it has additional hand-made manipulation) and use it as the beggining of panel for crime
crime <- read_xlsx("crime_rate/crime_2004.xlsx", skip = 3, 
                   col_names = c("state", "violent_crime_on100k", "property_crime_on100k"))
crime <- crime %>% mutate(total_crime_on100k = violent_crime_on100k + property_crime_on100k)
crime$year <- 2004
# code for processing other 19 spreadsheets
states <- data.frame(crime[1])
naming <- "crime_rate/crime_%s.xls" %--% list(c(1999:2018))
for (i in c(1:20)[c(-6)]) {
  data <- read_xls(naming[i], col_names = FALSE, skip = 4)
  block <- states
  violent_crime_on100k <- data %>% filter(...1 == "Rate per 100,000 inhabitants") %>% select(violent_crime_on100k=...2)
  property_crime_on100k <- data %>% filter(...1 == "Rate per 100,000 inhabitants") %>% select(property_crime_on100k=...3)
  block <- block %>% cbind(violent_crime_on100k) %>% cbind(property_crime_on100k)
  block <- block %>% mutate(violent_crime_on100k = as.numeric(violent_crime_on100k),
                            property_crime_on100k = as.numeric(property_crime_on100k),
                            total_crime_on100k = violent_crime_on100k + property_crime_on100k)
  block$year <- 1998 + i
  crime <- rbind(crime, block)
}
crime <- crime[c(1,5,2:4)]

#clean environment from already used variables for previous manipulations
rm(a, data, block, states, property_crime_on100k, violent_crime_on100k, total_crime_on100k)


# source: https://www2.census.gov/programs-surveys/popest/datasets
# read two databases, make some manipulations to get total population by state by year
pop <- read.csv("pop/pop00-10.csv")
pop00_10 <- pop %>% filter(SEX == 0,  ORIGIN == 0, RACE == 0, AGEGRP ==0) %>% 
  gather(year, pop, "POPESTIMATE2000":"POPESTIMATE2009") %>%
  group_by(NAME, year) %>% summarise(population=sum(pop))

pop <- read.csv("pop/pop10-18.csv")
pop10_18 <- pop %>% filter(SEX == 0, ORIGIN == 0) %>% 
  gather(year, pop, "POPESTIMATE2010":"POPESTIMATE2018") %>%
  group_by(NAME, year) %>% summarise(population=sum(pop))

# chain two tables
population <- rbind(pop00_10, pop10_18)
# make some fixing
population$year <- substr(population$year, 12, 15)
names(population)[1] <- "state"
population$year <- as.numeric(population$year)

# clean memory
rm(pop, pop00_10, pop10_18)


# source: http://www.census.gov/data/tables/time-series/demo/income-poverty/cps-pov/pov-46.html
# processing poverty data: read csv and excel files, then combine them
naming <- "poverty/pov_%s.csv" %--% list(2007:2009)
poverty <- data.frame()
for (i in c(1:length(naming))) {
  a <- read.csv(naming[i], skip = 10, header = FALSE, nrows = 52) %>% select(state=V1, poverty=V5)
  a$year <- 2006 + i
  poverty <- rbind(poverty, a)
}
naming <- "poverty/pov_%s.xls" %--% list(2010:2018)
for (i in c(1:length(naming))) {
  a <- read_xls(naming[i], skip = 11, col_names = FALSE, n_max = 52) %>% select(state=...1, poverty=...5)
  a$year <- 2009 + i
  poverty <- rbind(poverty, a)
}
poverty <- poverty[c(1,3,2)]
a <- read_xls("poverty/pov_1999-2006.xls", col_names = TRUE, n_max = 52) %>%
  gather(year, poverty, -state)
poverty <- rbind(poverty, a)
poverty$year <- as.numeric(poverty$year)


# source: https://www2.census.gov/programs-surveys/popest/datasets
# huge processing to get percent of male, black and hispanic origin people
sex_and_race <- data.frame()
# loop for processing 51 state datasets for 2000-2009 years
for (name in unique(tolower(overdose$state))[-1]) {
  a <- data.frame(state = name, year = c(2000:2009))
  file_name <- "race00-10/%s.xls" %--% name
  data <- read_xls(file_name, skip = 4, n_max = 72, col_names = FALSE)
  vital <- data[c(1,4,17,25), c(1,3:12)]
  # make some calculations
  a$percent_male <- t(vital[4, 2:11]) / t(vital[1, 2:11])
  a$percent_black <- t(vital[2, 2:11]) / t(vital[1, 2:11])
  a$percent_hisp_origin <- t(vital[3, 2:11]) / t(vital[1, 2:11])
  # chain tables
  sex_and_race <- rbind(sex_and_race, a)
}
# processing dataset for 2010-2018 years
data <- read.csv("race10-18.csv") %>% 
  filter(Sex.id %in% c("male", "totsex"), Hisp.id != "nhisp",
         substr(Year.display.label, 1, 5) != "April") %>%
  mutate(state = GEO.display.label,
         year = as.numeric(substr(Year.id, 5, 8)),
         sex = Sex.id, hisp_orig = Hisp.id,
         wac = as.numeric(as.character(wac)),
         bac = as.numeric(as.character(bac)),
         iac = as.numeric(as.character(iac)),
         aac = as.numeric(as.character(aac)),
         nac = as.numeric(as.character(nac)),
         all = wac + bac + iac + aac + nac) %>%
  select(state, year, sex, hisp_orig, wac, bac, iac, aac, nac, all)

# and getting useful information about percent of black
a <- data %>% filter(sex == "totsex", hisp_orig == "tothisp") %>% 
  mutate(percent_black = bac / all) %>%
  select(state, year, percent_black) %>% arrange(state, year)

# and percent of male
b1 <- data %>% filter(sex == "totsex", hisp_orig == "tothisp") %>% arrange(state, year) %>% select(all)
b2 <- data %>% filter(sex == "male", hisp_orig == "tothisp") %>% arrange(state, year) %>% select(all)
b <- b2 / b1
names(b) <- "percent_male"

a <- cbind(a, b)

# and percent of hispanic origin
b1 <- data %>% filter(sex == "totsex", hisp_orig == "tothisp") %>% arrange(state, year) %>% select(all)
b2 <- data %>% filter(sex == "totsex", hisp_orig == "hisp") %>% arrange(state, year) %>% select(all)
b <- b2 / b1
names(b) <- "percent_hisp_origin"

a <- cbind(a, b)

# make some corrections
a$state <- tolower(a$state)
a <- a[c(1,2,4,3,5)]

# and chain: it's the end of huge processing
sex_and_race <- rbind(sex_and_race, a)

# some cleaning
rm(vital, a, b, b1, b2, data)




# Avengers, assemble!
# make all state columns identical
ov <- overdose
overdose$state <- tolower(overdose$state)
legal$state <- tolower(legal$state)
crime$state <- tolower(crime$state)
gdp_per_cap_real$state <- tolower(gdp_per_cap_real$state)
personal_income_per_cap$state <- tolower(personal_income_per_cap$state)
unemployment$state <- tolower(unemployment$state)
population$state <- tolower(population$state)
poverty$state <- tolower(poverty$state)
overdose$year = as.integer(overdose$year)

# join all panel datas
panel_data <- full_join(overdose, legal, by=c("state", "year")) %>%
  full_join(crime, by=c("state", "year")) %>% full_join(gdp_per_cap_real, by=c("state", "year")) %>%
  full_join(personal_income_per_cap, by=c("state", "year")) %>% full_join(unemployment, by=c("state", "year")) %>%
  full_join(population, by=c("state", "year")) %>% full_join(alco_consumption, by=c("state", "year")) %>%
  full_join(poverty, by=c("state", "year")) %>% full_join(sex_and_race, by=c("state", "year"))

# prepare data for analysis
panel_data_clear <- subset(panel_data, !(state %in% c("puerto rico", "new england", "mideast", 
                                                      "great lakes", "plains", "southeast", 
                                                      "southwest", "rocky mountain", "far west", 
                                                      "northeast region", "midwest region", 
                                                      "south region", "west region", "us total", "united states"))) %>%
                    mutate(med = replace_na(med, 0),
                           full = replace_na(full, 0)) %>%
                    filter(year >= 1999 & year<=2018) %>%
                    arrange(state, year)%>% drop_na()

# if you need to save data in csv format, use the next command:
# write.csv(panel_data_clear, "panel.csv")

# Graphic analysis

panel_data_clear %>% gather(crime, rate, violent_crime_on100k:property_crime_on100k) %>%
  group_by(year, crime) %>% summarise(avg_rate = mean(rate, na.rm = TRUE)) %>% 
  ggplot(aes(x=year, y=avg_rate, colour=crime)) + geom_line() +
  ggtitle("Нисходящая динамика уровня преступности") +
  labs(x = "Годы", y = "Среднее количество преступлений на 100.000 человек",
       colour = "Виды преступлений")

panel_data_clear %>% 
  ggplot(aes(x=factor(year), y=alldrugs_death_rate)) + geom_boxplot() + 
  ggtitle("Восходящая динамика количества передозов всеми видами наркотиков") +
  labs(x = "Годы", y = "Количество передозировок на 100.000 человек")

panel_data_clear %>% 
  ggplot(aes(x=factor(year), y=opioid_death_rate)) + geom_boxplot() + 
  ggtitle("Восходящая динамика количества передозов опиоидами") +
  labs(x = "Годы", y = "Количество передозировок на 100.000 человек")

panel_data_clear %>% 
  ggplot(aes(x=factor(med), y=alldrugs_death_rate)) + geom_boxplot() +
  ggtitle("Различный разброс данных по передозировкам") +
  labs(x = "Статус медицинской легализации", y = "Количество передозировок на 100.000 человек")

panel_data_clear %>% 
  ggplot(aes(x=factor(full), y=alldrugs_death_rate)) + geom_boxplot() +
  ggtitle("Различный разброс данных по передозировкам") +
  labs(x = "Статус рекреационной (полной) легализации", y = "Количество передозировок на 100.000 человек")

ggcorrplot(round(cor((panel_data_clear%>%select(-c("state","population","year","total_crime_on100k")))),2),
           lab = TRUE,lab_size = 5)+theme(axis.text.x = element_text(color = "grey20", size = 30),axis.text.y =element_text(color = "grey20", size = 30),text = element_text(size = 20))

# summary statistics
#install.packages("psych")
#library(psych)
#data <- panel_data_clear %>% select(-c(1, 3:4, 6, 8)) %>% group_by(year)
#summary <- data.frame(describeBy(data, group="year", mat=TRUE, type=0, digits=2)) %>% select(2, 4:7, 10:11)
#summary <- summary[-c(1:21),] %>% drop_na()
#names(summary)[1] <- "year"

#summary$variable <- row.names(summary)
#s <- summary %>% filter(year %in% c(2000, 2005, 2010, 2015))
#s <- s[c(8, 1:7)]


med_leg = read_xlsx('med_leg.xlsx', col_names = TRUE)
tab_long <- melt(med_leg, id = c("state"), na.rm = TRUE, value.name = "legal",variable.name = "year")
ov$year = as.factor(ov$year)
tab_long <- tab_long%>%left_join(ov,by = c('year','state'))
clean_leg <-  leg[rowSums(is.na(leg[2:5])) != 4, ]
clean_leg[is.na(clean_leg)] <-  "-"


plot1 <- ggplot(subset(tab_long,tab_long$state %in% clean_leg[["state"]]), aes(x = year, y = opioid_death_rate, col = factor(legal)))+geom_line(aes(group = state), size = 2)+facet_wrap(.~state)+
theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom", legend.direction = "horizontal")+
  scale_color_manual(name="Cтепень легализации", labels = c("Полный запрет", "Для медицинских целей","Для рекреацонных целей"), values=c("green", "purple", "orange"))+
  scale_x_discrete(breaks = c(seq(1999,2018,3)))+labs(x = "Годы", y = "Количество передозировок на 100.000 человек")

plot2 <- tab_long%>% 
  ggplot(aes(x=factor(year), y=opioid_death_rate, color = as.factor(legal))) + geom_boxplot() + 
  labs(x = "Годы", y = "Количество передозировок на 100.000 человек")+
  scale_color_manual(name="Cтепень легализации: ", labels = c("Полный запрет", "Для медицинских целей","Для рекреацонных целей"), values=c("green", "purple", "orange"))+
  theme(legend.position = "bottom", legend.direction = "horizontal", axis.text.x = element_text(angle = 70, hjust = 1))

plot3 <- tab_long%>% 
  ggplot(aes(x=factor(year), y=alldrugs_death_rate, color = as.factor(legal))) + geom_boxplot() + 
  labs(x = "Годы", y = "Количество передозировок на 100.000 человек")+
  scale_color_manual(name="Cтепень легализации: ", labels = c("Полный запрет", "Для медицинских целей","Для рекреацонных целей"), values=c("green", "purple", "orange"))+
  theme(legend.position = "bottom",    legend.direction = "horizontal", axis.text.x = element_text(angle = 70, hjust = 1))

p4 <- ggcorrplot(round(cor((panel_data_clear%>%select(-c("state","population","year","total_crime_on100k")))),2),lab = TRUE,lab_size = 5)


cor(na.omit(panel_data%>%select(c(3,5))))
cor(na.omit(panel_data%>%select(c(3,7))))
cor(na.omit(panel_data%>%select(c(4,5))))
cor(na.omit(panel_data%>%select(c(4,7))))
```

\section{Исследовательский вопрос}

Мы собираемся выяснить, как легализация использования марихуаны в медицинских и рекреационных целях влияет на смертность от передозировок опиоидами, и существует ли причино-следственная связь
между этими показателями.

\section{Описание переменных}


\begin{itemize}
  \item $opioid\_death\_rate$ -- Коэффициент смертности от передозировки опиоидными наркотическими веществами; на 100,000 человек. \href{https://www.kff.org/other/state-indicator/opioid-overdose-death-rates}{(KFF)}
  \item $alldrugs\_death\_rate$ -- Коэффициент смертности от передозировки наркотическими веществами (любыми); на 100,000 человек. \href{https://www.kff.org/other/state-indicator/opioid-overdose-death-rates}{(KFF)}
  \item $med$ -- Бинарная переменная, равная 1, если в $i$-том штате был принят закон о легализации употребления марихуаны в медицинских целях.\href{http://www.ncsl.org/research/health/state-medicalmarijuana-
laws.aspx}{(NCSL)}\href{http://pdaps.org/datasets/recreational-marijuana-laws}{(PDAPS)}\href{http://www.mpp.org/states/}{(MPP)}
  \item $full$ -- Бинарная переменная, равная 1, если в $i$-том штате был принят закон о легализации употребления марихуаны в рекреационных целях.\href{http://www.ncsl.org/research/health/state-medicalmarijuana-
laws.aspx}{(NCSL)}\href{http://pdaps.org/datasets/recreational-marijuana-laws}{(PDAPS)}\href{http://www.mpp.org/states/}{(MPP)}
  \item $violent\_crime\_on100k$ -- Уровень насильственной преступности (убийства, изнасилования и тд); на 100,000 человек.\href{https://ucr.fbi.gov/crime-in-the-u.s}{(FBI)}
  \item $property\_crime\_on100k$ -- Уровень преступности против частной собственности (кража, порча имущества, вандализм и тд); на 100,000 человек. \href{https://ucr.fbi.gov/crime-in-the-u.s}{(FBI)}
  \item $total\_crime\_on100k$ -- Общий уровень преступности на 100,000 человек. \href{https://ucr.fbi.gov/crime-in-the-u.s}{(FBI)}
  \item $gdp\_per\_cap$ -- Реальный ВВП на душу населения, \$.\href{https://apps.bea.gov/iTable/iTable.cfm?acrdn=2&isuri=1&reqid=70&step=1#acrdn=2&isuri=1&reqid=70&step=1}{(BEA)}
  \item $personal\_income\_per\_cap$ -- Персональный доход, \$.\href{https://apps.bea.gov/iTable/iTable.cfm?acrdn=2&isuri=1&reqid=70&step=1#acrdn=2&isuri=1&reqid=70&step=1}{(BEA)}
  \item $unemployment$ -- Уровень безработицы, \%.\href{https://www.icip.iastate.edu/tables/employment/unemployment-states}{(ICIP)}
  \item $alco\_consumption$ -- Потребление алкоголя на душу населения, галлонов.\href{https://www.openicpsr.org/openicpsr/project/105583/version/V3/view;jsessionid=5A68D3A66B257C49163707BF7B76B1EE}{(ICPSR)}
  \item $poverty$ -- Уровень бедности, \%. \href{http://www.census.gov/data/tables/time-series/demo/income-poverty/cps-pov/pov-46.html}{(Census)}
  \item $percent\_male$ -- Процент мужчин в общей численности населения, \%.\href{https://www2.census.gov/programs-surveys/popest/datasets}{(Census)}
  \item $percent\_black$ -- Процент темнокожего населения, \%.\href{https://www2.census.gov/programs-surveys/popest/datasets}{(Census)}
  \item $percent\_hisp_origin$ -- Процент населения латиноамериканского происхождения, \%.\href{https://www2.census.gov/programs-surveys/popest/datasets}{(Census)}
\end{itemize}

\section{Предварительный анализ данных}
  За период наблюдений с 1999 года по нынешний момент в США наблюдается непрерывный рост числа передозировок наркотиками с летальными исходами, в том числе увеличивается и доля смертей от наркотиков опиоидной группы. Данное событие получило название опиоидного кризиса, с которым власти стали пытаться бороться, начиная с 2011 года. Опиоиды являются активными веществами сильных обезболивающих, выписывающихся по рецепту. Проведем анализ штатов, где были предприняты попытки с помощью законодательства изменить негативную тенденцию.
  
  В табл.1 приведены даты вступления в силу законов о легализации использования марихуаны для медицинских или рекреационных целей. Первым штатом, легализовавшим марихуану для медицинского использования, была Калифорния (1996), а Колорадо и Вашингттон первыми легализовали марихуану для рекреационных целей (2012). На сегодняшний день всего 29 штатов и один округ легализовали использование марихуаны в медицинских целях, наша выборка для построения панели будет ограничена ими.
  
  Графический анализ данных (Рис.2,3) отражает тенденцию роста смертности от передозировки наркотиками с 1999 по 2017 года. Зеленым цветом показана тенденция изменения смертности от передозировки наркотическими веществами до принятия в штате закона о легализации марихуаны на каком-либо уровне: в медицинских целях или в рекреационных. Последние два факта отражены на графиках фиолетовым и оранжевым цветом соответственно. Во многих штатах наблюдается резкое увеличение коэффициента смертности после легализации марихуаны на одном из уровней - это Делавэр, Массачусетс, Коннектикут, Нью-Гэмпшир, Нью-Джерси в 2014-2017 годах. 
Однако резкий рост смертности наблюдается и в некоторых штатах до принятия данного закона: Огайо в 2011-2014 годах, Пенсильвания 2010-2016 годах.

```{r,echo=FALSE, fig.height=40, fig.width=30, message=FALSE, warning=FALSE,fig.align ='center', fig.cap='Количество смертей от передоировок опиоидами (на 100 000 населения штата)'}
plot1
```



```{r,echo=FALSE, fig.height=15, fig.width=25, message=FALSE, warning=FALSE, fig.pos='h!', fig.cap='Динамика количества передозировок опиоидами'}
plot2
```

```{r,echo=FALSE, fig.height=15, fig.width=25, message=FALSE, warning=FALSE, fig.pos='h!', fig.cap='Динамика количества передозировок всеми типами наркотиков'}
plot2
```



  На годовых диаграммах размаха () можно наблюдать рост смертности от передозировки наркотическими средствами в среднем по США за 1999-2018 года вне зависимости от степени легализации марихуаны. Динамика смертности в среднем по США с полным запретом наркотических средств отражена зелёным цветом, фиолетовым и оранжевым цветом - где марихуана легализована в медицинских или рекреационных целях соотвественно. 
На графике наблюдается рост смертности в среднем по всем штатам в независимости от статуса легализации. 
Также с 2014 года наблюдается большая дифференциация штатов по данному показателю, что можно понять по увеличивающему межквартильному размаху.


```{r,echo=FALSE,results = "asis"}
clean_leg = leg[rowSums(is.na(leg[c(2,3,4,5)])) != 4, ]
clean_leg[is.na(clean_leg)] = "-"
stargazer(clean_leg%>%select(c(1,2,4)), summary = FALSE, title = "Год вступления в силу закона о полной/частичной легализации", header = FALSE)
```
```{r fig.height=40, fig.width=40}
cormat <- matrix(0 ,ncol(panel_data),ncol(panel_data))
for(i in 2:(ncol(panel_data)-1)){
  for(j in (i+1):ncol(panel_data))
    cormat[i,j] <- cor(na.omit(panel_data%>%select(c(i,j))))[2,1]
    # print(paste("corr between ", names(panel_data)[i]," and ",names(panel_data)[j], " is ", 
          # cor(na.omit(panel_data%>%select(c(i,j))))[2,1]))
}


rownames(cormat) <- names(panel_data)

colnames(cormat) <- names(panel_data)
ggcorrplot(round(cormat,2), lab = TRUE,lab_size = 5)+
theme(axis.text.x = element_text(color = "grey20", size = 30, angle = 45),axis.text.y =element_text(color = "grey20", size = 30),text = element_text(size = 20))


```

```{r echo=FALSE, message=TRUE, warning=TRUE}

states_map <- map_data("state")
ggplot(panel_data%>%subset(year = 2017), aes(map_id = tolower(state))) + 
    geom_map(aes(fill = opioid_death_rate), map = states_map) + 
    expand_limits(x = states_map$long, y = states_map$lat)+theme_bw()
```





\nocite{esser2019binge}
\nocite{jacobi2016marijuana}
\nocite{cussen2000legalize}
\nocite{dragone2019crime}
\nocite{brinkman2019not}
\nocite{mark2013medical}
\nocite{anderson2014legalization}
\nocite{alpert2019origins}





